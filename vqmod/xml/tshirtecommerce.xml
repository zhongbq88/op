<modification>
	<id>tshirtecommerce</id>
	<version>4.1.5</version>
	<vqmver>2.4.0</vqmver>
	<author>Tshirtecommerce Team</author>
	
	<file name="system/library/cart/cart.php,system/storage/modification/system/library/cart/cart.php">
		<operation error="skip">
			<search position="after"><![CDATA[$option_data = array()]]></search>
			<add><![CDATA[
				$temp_options = json_decode($cart['option'], true);
				if (isset($temp_options['design'])) {
					$design = $temp_options['design'];
				} else {
					$design = false;
				}

				if (!isset($design['rowid']) ) {
					$design = false;
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[$product_data[] = array(]]></search>
			<add><![CDATA[
				$tshirtecommerce_design = 0;
				if ($design !== false) {
					if (!defined('DS')) define('DS', DIRECTORY_SEPARATOR);
			        if (!defined('ROOT')) define('ROOT', dirname(DIR_SYSTEM).DS.'tshirtecommerce');
			        include_once(ROOT.'/includes/functions.php');
			        $dg = new \dg();

			        if (!is_numeric($design['rowid']) && isset($design['rowid']) && !empty($design['rowid'])) {
			        	$rowid = $design['rowid'];
			        	$cache = $dg->cache('cart');
        				$tdesign = $cache->get($rowid);

        				if ($tdesign != false && $tdesign != null) {
	        				$tdata['colors'] = array($tdesign['color']);
				            $tdata['product_id'] = $tdesign['item']['product_id'];
				            $tdata['print'] = $tdesign['print'];
				            $tdata['cliparts'] = $tdesign['cliparts'];
			            } else {
			            	$tdata['colors'] = isset($this->session->data[$rowid]['colors']) ? $this->session->data[$rowid]['colors'] : array();
				            $tdata['product_id'] = isset($this->session->data[$rowid]['product_id']) ? $this->session->data[$rowid]['product_id'] : 0;
				            $tdata['print'] = isset($this->session->data[$rowid]['print']) ? $this->session->data[$rowid]['print'] : array();
				            $tdata['cliparts'] = isset($this->session->data[$rowid]['cliparts']) ? $this->session->data[$rowid]['cliparts'] : array();
			            }
			            $tdata['quantity'] = $cart['quantity'];
			            $tdata['price_taxes'] = 0;
			            $tdata['price_old_oc'] = $price;
			            $tdata['price_sale_oc'] = $price;
			            $tdata['attribute'] = array();
			            $tdata['is_shopping_cart'] = 1;
			           	if (isset($this->session->data[$rowid]) && isset($this->session->data[$rowid]['attribute'])) {
			           		$tdata['attribute'] = $this->session->data[$rowid]['attribute'];
			           	}
			            $tdata['artStore'] = array();
			            $evector = isset($tdesign['vector']) ? $tdesign['vector'] : '';
			            if (!empty($evector)) {
			                $json_evector = @json_decode($evector, true);
			                if (count($json_evector)) {
			                    foreach ($json_evector as $view => $items) {
			                        if (count($items)) {
			                            foreach ($items as $item) {
			                                if (isset($item['clipar_type']) && $item['clipar_type'] == 'store') {
			                                    $tdata['artStore'][] = $item['clipart_id'];
			                                }
			                            }
			                        }
			                    }
			                }
			            }
			            $tshirtecommerce_prices = @$dg->prices($tdata, false);
			        } else {
			        	if (isset($design['rowid']) && isset($design['design_printing'])) {
				        	$rowid = $design['rowid'];
				        	$tdata['product_id'] = $design['rowid'];
				        	$tdata['colors'] = array($design['color_hex']);
				        	$tdata['quantity'] = $cart['quantity'];
				        	$tdata['price_taxes'] = 0;
				        	$tdata['price_old_oc'] = $price;
				        	$tdata['price_sale_oc'] = $price;
				            $tdata['attribute'] = $this->session->data[$rowid]['attribute'];
				        	$tdata['artStore'] = array();
				        	$tdata['print'] = array(
				        		'sizes' => '{}',
				        		'elements' => '{front: [], back: [], left: [], right: []}',
				        		'colors' => '{front:[], back:[], left:[], right:[]}'
				        	);
				        	$tdata['print_type'] = $design['design_printing'];
				        	$tshirtecommerce_prices = $dg->prices($tdata, false);
			        	}
			        }
			        if (isset($tshirtecommerce_prices) && is_object($tshirtecommerce_prices)) {
				        if (property_exists($tshirtecommerce_prices, 'item') && $tshirtecommerce_prices->item > 0) {
			                $tshirtecommerce_design += $tshirtecommerce_prices->item - $price;
			            } elseif (property_exists($tshirtecommerce_prices, 'printing') && $tshirtecommerce_prices->printing > 0) {
			            	$tshirtecommerce_design += $tshirtecommerce_prices->printing;
			            }
			        }
				}
				$option_price += $tshirtecommerce_design;
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[$reward * $cart['quantity'],]]></search>
			<add><![CDATA[
				'design' => $design,
			]]></add>
		</operation>		
	</file>

	<file name="admin/controller/common/logout.php,system/storage/modification/admin/controller/common/logout.php">
		<operation error="skip">
			<search position="after"><![CDATA[$this->user->logout();]]></search>
			<add><![CDATA[
				$sess_file = dirname(DIR_SYSTEM).'/tshirtecommerce/admin/tmp/session_'.session_id();
				if (file_exists($sess_file)) {
					unlink($sess_file);
				}
				unset($_SESSION['is_admin']);
				unset($this->session->data['is_admin']);
			]]></add>
		</operation>
	</file>
	<file name="admin/view/template/common/header.tpl,system/storage/modification/admin/view/template/common/header.tpl">
		<operation error="skip">
			<search position="after"><![CDATA[name="viewport"]]></search>
			<add><![CDATA[
				<link href="view/stylesheet/tshirtecommerce.css" type="text/css" rel="stylesheet" />
			]]></add>
		</operation>
	</file>
	<file name="admin/controller/common/column_left.php,system/storage/modification/admin/controller/common/column_left.php">
		<operation error="skip">
			<search position="before"><![CDATA[$extension = array();]]></search>
			<add><![CDATA[
				$tshirtecommerce = array();
				if ($this->user->hasPermission('access', 'catalog/tshirtecommerce')) {	
					$tshirtecommerce[] = array(
						'name' => 'Product Build',
						'href' => $this->url->link('catalog/tshirtecommerce/index', 'token='.$this->session->data['token'], true),
						'children' => array()		
					);	
				}
				if ($this->user->hasPermission('access', 'module/tshirtecommerce')) {	
					$tshirtecommerce[] = array(
						'name' => 'Settings',
						'href' => $this->url->link('module/tshirtecommerce', 'token='.$this->session->data['token'], true),
						'children' => array()		
					);
					$tshirtecommerce[] = array(
						'name' => 'Update',
						'href' => $this->url->link('catalog/tshirtecommerce/update', 'token='.$this->session->data['token'], true),
						'children' => array()		
					);		
				}
				if ($tshirtecommerce) {
					$data['menus'][] = array(
						'id' => 'menu-tshirtecommerce',
						'icon' => 'fa-tshirtecommerce', 
						'name' => 'T-Shirt eCommerce',
						'href' => '',
						'children' => $tshirtecommerce
					);		
				}
			]]></add>
		</operation>
	</file>

	<file name="admin/controller/catalog/product.php,system/storage/modification/admin/controller/catalog/product.php">
		<operation error="skip">
			<search position="after"><![CDATA[$this->load->language('catalog/product');]]></search>
			<add><![CDATA[
				$this->load->model('user/user');
				$user_info = $this->model_user_user->getUser($this->user->getId());
				$logged = array(
					'login' => true,
					'email' => $user_info['email'],
					'id' => $user_info['user_id']
				);
				$_SESSION['is_admin'] = $logged;
				$this->session->data['is_admin'] = $logged;
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[catalog/product_form]]></search>
			<add><![CDATA[
				$this->load->model('tshirtecommerce/product');
				if (isset($this->request->get['product_id'])) {
					$tshirtecommerce_data = $this->model_tshirtecommerce_product->get_product($this->request->get['product_id']);
					if ($tshirtecommerce_data !== false && count($tshirtecommerce_data) > 0) {
						$data['print_type'] = $tshirtecommerce_data['print_type'];
						$data['print_types'] = $tshirtecommerce_data['print_types'];
						$data['show_attribute'] = $tshirtecommerce_data['show_attribute'];
						$data['design'] = $tshirtecommerce_data['design'];
					}
				}
				$data['ts_language_default'] = $data['languages'][$this->config->get('config_language')]['language_id'];
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[$this->model_localisation_language->getLanguages();]]></search>
			<add><![CDATA[				
				if (isset($this->request->post['design_product_id'])) {
					$data['design_product_id'] = $this->request->post['design_product_id'];
				} elseif (isset($product_info['design_product_id'])) {
					$data['design_product_id'] = $product_info['design_product_id'];
				} else {
					$data['design_product_id'] = '';
				}

				if (isset($this->request->post['design_product_title_img'])) {
					$data['design_product_title_img'] = $this->request->post['design_product_title_img'];
				} elseif (isset($product_info['design_product_title_img'])) {
					$data['design_product_title_img'] = $product_info['design_product_title_img'];
				} else {
					$data['design_product_title_img'] = '';
				}
			]]></add>
		</operation>
	</file>
	<file name="admin/model/catalog/product.php,system/storage/modification/admin/model/catalog/product.php">
		<operation error="skip">
			<search position="after"><![CDATA[$product_id = $this->db->getLastId();]]></search>
			<add><![CDATA[
				if (isset($data['design_product_id'])) {
					$this->db->query("
						UPDATE `".DB_PREFIX."product` 
						SET `design_product_id` = '".$this->db->escape($data['design_product_id'])."' 
						WHERE `product_id` = '".(int)$product_id."'
					");
				}
				if (isset($data['design_product_title_img'])) {
					$this->db->query("
						UPDATE `".DB_PREFIX."product` 
						SET `design_product_title_img` = '".$this->db->escape($data['design_product_title_img'])."' 
						WHERE `product_id` = '".(int)$product_id."'
					");
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[public function editProduct]]></search>
			<add><![CDATA[
				if (isset($data['design_product_id'])) {
					$this->db->query("
						UPDATE `".DB_PREFIX."product` 
						SET `design_product_id` = '".$this->db->escape($data['design_product_id'])."' 
						WHERE `product_id` = '".(int)$product_id."'
					");
				}
				if (isset($data['design_product_title_img'])) {
					$this->db->query("
						UPDATE `".DB_PREFIX."product` 
						SET `design_product_title_img` = '".$this->db->escape($data['design_product_title_img'])."' 
						WHERE `product_id` = '".(int)$product_id."'
					");
				}
			]]></add>
		</operation>			
	</file>
	<file name="admin/controller/sale/order.php,system/storage/modification/admin/controller/sale/order.php">
		<operation error="skip">
			<search position="after" index="2"><![CDATA[$this->model_sale_order->getOrderProducts($this->request->get['order_id']);]]></search>
			<add><![CDATA[
				if (!defined('DS')) define('DS', DIRECTORY_SEPARATOR);
				if (!defined('ROOT')) define('ROOT', dirname(DIR_SYSTEM).DIRECTORY_SEPARATOR.'tshirtecommerce');

				if (file_exists(ROOT.DS.'includes'.DS.'functions.php')) {
					include_once ROOT.DS.'includes'.DS.'functions.php';
					$dg = new dg();
					include_once ROOT.DS.'includes'.DS.'addons.php';
					$addons = new addons();

					$data['tshirtecommerce_designer_cart_edit'] = $addons->__('designer_cart_edit');
					$data['tshirtecommerce_link_text_download'] = $addons->__('tshirtecommerce_link_text_download');
					$data['tshirtecommerce_link_title_download'] = $addons->__('tshirtecommerce_link_title_download');
					$data['tshirtecommerce_link_title_edit'] = $addons->__('tshirtecommerce_link_title_edit');
					$data['tshirtecommerce_view_front'] = $addons->__('tshirtecommerce_view_front');
					$data['tshirtecommerce_view_left'] = $addons->__('tshirtecommerce_view_left');
					$data['tshirtecommerce_view_right'] = $addons->__('tshirtecommerce_view_right');
					$data['tshirtecommerce_view_back'] = $addons->__('tshirtecommerce_view_back');
					$data['ts_designer_clipart_edit_name'] = $addons->__('designer_clipart_edit_name');
					$data['ts_designer_clipart_edit_number'] = $addons->__('designer_clipart_edit_number');
					$data['tshirtecommerce_head_text_sizes'] = $addons->__('tshirtecommerce_head_text_sizes');
					$data['tshirtecommerce_link_view_design'] = $addons->__('tshirtecommerce_link_view_design');
					$data['tshirtecommerce_label_or_download_design'] = $addons->__('tshirtecommerce_label_or_download_design');
					$data['tshirtecommerce_printing_type'] = $addons->__('tshirtecommerce_printing_type');
				}
				$this->load->model('tshirtecommerce/order');
				$base_url = (isset($this->request->server['HTTPS']) && (($this->request->server['HTTPS'] == 'on') || ($this->request->server['HTTPS'] == '1'))) ? HTTPS_CATALOG : HTTP_CATALOG;

				$data['base_url'] = $base_url;
				$data['tshirtecommerce_url'] = $this->url->link('tshirtecommerce/designer', '', true);
				$dir_admins = explode('/', DIR_APPLICATION);
				$dir_admin = empty($dir_admins[count($dir_admins) - 1]) ? $dir_admins[count($dir_admins) - 2] : $dir_admins[count($dir_admins) - 1];
				if (strpos($data['tshirtecommerce_url'], '/'.$dir_admin) !== false) {
					$data['tshirtecommerce_url'] = str_replace('/'.$dir_admin, '', $data['tshirtecommerce_url']);
				} else {
					$data['tshirtecommerce_url'] = str_replace($dir_admin, '', $data['tshirtecommerce_url']);
				}
				$settings = $dg->getSetting();
				$data['store_enable'] = isset($settings->store->enable) ? $settings->store->enable : 0;
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[$data['products'][]]]></search>
			<add><![CDATA[
				$_data = $this->model_tshirtecommerce_order->getItem($product['order_product_id'], $product['product_id']);
				$chk_return = false;				
				$store_setting = array();
				$store_temp = array();
				$msg_store_empty = '';
				if (isset($dg) && $_data !== false && isset($_data->rowid)) {
					$cache = $dg->cache('cart');
					$design = $cache->get($_data->rowid);
					$order_item = $design['item'];
					$arts = array();
					$prices = 0;
					$qty = (int) ($order_item['qty'] / 10);
					if ($qty < 1) $qty = 1;
					
					if (isset($design['vector'])) {
						$ids = array();
						$vectors = json_decode($design['vector'], true);
						if (count($vectors)) {
							foreach ($vectors as $view => $items) {
								if (count($items)) {
									foreach ($items as $item) {
										if (isset($item['clipar_type']) && empty($item['clipar_paid'])) {
											if(empty($item['price'])) $item['price'] = 0;
											if(is_string($item['file'])) $file = $item['file'];
											if(isset($item['file']['type'])) $file = $item['file']['type'];
											$arts[$item['clipart_id']] = array(
												'view' => $view,
												'id' => $item['clipart_id'],
												'title'	=> $item['title'],
												'thumb'	=> $item['thumb'],
												'file' => $file,
												'price'	=> $item['price'],
											);
											if (!in_array($item['clipart_id'].'-'.$qty, $ids)) {
												$prices = $prices + ($item['price'] * $qty);
												$ids[] = $item['clipart_id'].'-'.$qty;
											}
										}
									}
									// update info after paid
									if (isset($this->request->get['e_order_id']) && isset($this->request->get['params']) 
										&& count($ids) > 0 && $_data->rowid == $this->request->get['e_order_id']) {
										$e_order_id = $this->request->get['e_order_id'];
										$params = $this->request->get['params'];
										$settings = $dg->getSetting();
										$api = $settings->store->api;
										$this->model_tshirtecommerce_order->store_art_update($e_order_id, $params, array(), $api);
										$chk_return = true;
									}
								}
							}
						}
					}
					if (count($arts) && $chk_return == false) {
						$settings = $dg->getSetting();
						if (empty($settings->store)) {
							$msg_store_empty = '<p style="background-color: #fcf8e3;color:#8a6d3b;border: 1px solid #faebcc;padding:14px 12px;margin: 0px;">Your order using arts of <a href="http://store.9file.net/" target="_blank">store</a>. You missing setup API Store. Please go to <strong>T-Shirt eCommerce > Settings > Configuration > Tab Config</strong> setup store to download file output.</p>';
						} elseif (empty($settings->store->api) || (isset($settings->store->api) && $settings->store->api == '')) {
							$msg_store_empty = '<p style="background-color: #fcf8e3;color:#8a6d3b;border: 1px solid #faebcc;padding:14px 12px;margin: 0px;">Your order using arts of <a href="http://store.9file.net/" target="_blank">store</a>. You missing setup API Store. Please go to <strong>T-Shirt eCommerce > Settings > Configuration > Tab Config</strong> setup store to download file output.</p>';
						} else {
							$api = $settings->store->api;
							$store_temp['api'] = $api;
							$store_temp['ids'] = $ids;
							$store_temp['ids'] = $ids;
							$store_temp['prices'] = $prices;
							$store_temp['arts'] = $arts;
							$store_temp['qty'] = $qty;
						}
					}
				}
				$this->load->model('user/user');
				$user_info = $this->model_user_user->getUser($this->user->getId());
					$logged = array(
					'login' => true,
					'email' => $user_info['email'],
					'id' => $user_info['user_id']
				);
				$_SESSION['is_admin'] = $logged;
				$this->session->data['is_admin'] = $logged;
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[$data['products'][]]]></search>
			<add><![CDATA[
				'design' => $_data,
				'_design' => isset($design) ? $design : array(),
				'store_temp' => $store_temp,
				'msg_store_empty' => $msg_store_empty,
				'u_return' => $chk_return,
			]]></add>
		</operation>
	</file>
	<file name="admin/view/template/sale/order_info.tpl,system/storage/modification/admin/view/template/sale/order_info.tpl">
		<operation error="skip">
			<search position="after"><![CDATA[echo $product['name']]]></search>
			<add><![CDATA[
			<?php 
			echo '<br />';
			$design = $product['design'];
			if (isset($store_enable) && $store_enable == 1) {
				if (!empty($product['msg_store_empty'])) {
					echo $product['msg_store_empty'];
				} else {
					if (count($product['store_temp']) > 0 && $product['u_return'] == false) {
						$store_temp = $product['store_temp'];
						echo '<div class="tshirt-header-storearts"><span class="lbl">Arts of Store</span><div>';
						echo '<link href="'.$base_url.'/tshirtecommerce/opencart/css/store.css" rel="stylesheet">';
						echo '<script> var store_ajaxurl = "'.$base_url.'"; </script>';
						echo '<script src="'.$base_url.'/tshirtecommerce/opencart/js/store.js"></script>';
						if ($store_temp['prices'] > 0) {
							echo '<p class="tshirt-alertpayment">Your order using arts of store with cost <strong>'.$store_temp['prices'].' Credits</strong>. Please payment before download file output. <a href="http://store.9file.net/" target="_blank">Read More</a></p>';
							echo '<p class="btnpaymentnow"><a href="javascript:void(0);" data-id="'.$store_temp['api'].'/'.implode('_', $store_temp['ids']).'/'.$design->rowid.'" onclick="payment.load(this);">Payment Now!</a></p>';
							echo '<script type="text/javascript">jQuery(document).ready(function(){payment.removeLink(\''.$design->rowid.'\');});</script>';
						} else {
							echo '<script type="text/javascript">jQuery(document).ready(function(){payment.key(\''.$store_temp['api'].'\', \''.implode('_', $store_temp['ids']).'\', \''.$design->rowid.'\')});</script>';
						}
						echo '<div class="arts-store table-responsive" style="overflow: hidden;"><table cellpadding="0" cellspacing="0" width="100%" class="tshirtecommerce-store-arts-order">';
						echo '<thead><tr><th>Position</th><th>Image</th><th>Price & Info</th></tr></thead><tbody>';
						foreach ($store_temp['arts'] as $art) {
							if ($art['price'] == 0) {
								$price_txt = '<strong>FREE</strong>';
							} else {
								$price_txt = 'Price: <strong>'.($art['price']*$store_temp['qty']).' Credits</strong><br />';
								$price_txt .= 'Quantity: <strong>'.$store_temp['qty'].'</strong>';
							}
							echo '<tr><td>'.$art['view'].'</td><td><a href="http://store.9file.net/arts/detail/'.$art['id'].'" target="_blank"><img width="100" src="'.$art['thumb'].'" alt="'.$art['title'].'" title="'.$art['title'].'"></a></td><td> '.$price_txt.'<br />File type: <strong>'.strtoupper($art['file']).'</strong></td></tr>';
						}
						echo '</tbody></table><div class="arts-store-payment"></div></div></div></div>';
					}
				}
			}
			
			if (isset($product['design']) && $product['design'] != false) {
				if (isset($design->design_product_id) && !empty($design->design_product_id)) {
					$_temp_arr = explode(':', $design->design_product_id);
					echo "<p class='form-group'>";
					if (count($_temp_arr) > 1) {
						$_key = $_temp_arr[0].':'.$_temp_arr[1].':'.$_temp_arr[2].':'.$design->color_hex;
						echo "<a href='".$base_url."index.php?route=tshirtecommerce/designer&product_id=".$_temp_arr[2]. '&parent_id='.$design->product_id ."&cart_id=".$design->rowid."' title='".$tshirtecommerce_link_title_edit."' target='_blank'><strong>".$tshirtecommerce_link_view_design."</strong></a>";
						if (!isset($design->images) || empty($design->images)) {
							echo ' '. $tshirtecommerce_label_or_download_design .':';
							echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='$base_url/tshirtecommerce/design.php?idea=1&key=".$_key."&view=front'><strong>".$tshirtecommerce_view_front."</strong></a> - ";
							echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='$base_url/tshirtecommerce/design.php?idea=1&key=".$_key."&view=back'><strong>".$tshirtecommerce_view_back."</strong></a> - ";
							echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='$base_url/tshirtecommerce/design.php?idea=1&key=".$_key."&view=left'><strong>".$tshirtecommerce_view_left."</strong></a> - ";
							echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='$base_url/tshirtecommerce/design.php?idea=1&key=".$_key."&view=right'><strong>".$tshirtecommerce_view_right."</strong></a>";
						}
					} else {
						if (isset($design->images) && !empty($design->images)) {
							echo "<a href='".$base_url."index.php?route=tshirtecommerce/designer&product_id=".$design->design_product_id."&parent_id=".$design->product_id."&cart_id=".$design->rowid."' title='' target='_blank'><strong>".$tshirtecommerce_designer_cart_edit."</strong></a>";
						}
					}
					echo "</p>";
				}
				if (isset($design->color_title)) { ?>
					<small><strong>Color:</strong> <span title="<?php echo $design->color_title; ?>" style="background-color:#<?php echo $design->color_hex; ?>;display:inline-block;border:1px solid #ccc;width:25px;height:25px;cursor:pointer;outline:1px solid #229BCA;margin-left 4px;"></span></small><br />
				<?php }

				if (isset($design->options) && $design->options != '[]') {
					if (is_string($design->options)) {
						$design_options = json_decode( str_replace('&quot;', '"', $design->options) );
					} else {
						$design_options = $design->options;						
					}
					$html = '';
					if (count($design_options)) {
						foreach ($design_options as $option) {					
							if (isset($option->value)) {
								if (is_string($option->value) && $option->value != '') {
									if(empty($option->name) && $option->type == 'printing') $option->name = $tshirtecommerce_printing_type; //'Printing type'
									$html .= '<dt>'.$option->name.': '.$option->value.'</dt>';
								} elseif (count($option->value) > 0) {
									$html .= '<dt>'.$option->name.': </dt>';
									$html .=  '<dd>';
									foreach ((array)$option->value as $name => $value) {
										if ($option->type == 'checkbox') {
											$html .=  $value. '; ';
										} else {
											if ($value != '0' && $value != 0) $html .= $name.'  -  '.$value. '; ';
										}
									}
									$html .=  '</dd>';
								}
							}
						}
					}
					echo $html;
				}

				if (isset($design->teams) && isset($design->teams->name)) {
					$teams = json_decode( json_encode($design->teams), true);
					$table = '<table class="table table-bordered">'
						. 		'<thead>'
						. 			'<tr>'
						. 				'<th>'.$ts_designer_clipart_edit_name.'</th>'
						. 				'<th>'.$ts_designer_clipart_edit_number.'</th>'
						. 				'<th>'.$tshirtecommerce_head_text_sizes.'</th>'
						. 			'</tr>'
						. 		'</thead>'
						. 		'<tbody>';
					for ($i = 1; $i <= count($teams['name']); $i++) {
						$size = explode('::', $teams['size'][$i]);
						$table .=	'<tr>'
							.			'<td>'.$teams['name'][$i].'</td>'
							.			'<td>'.$teams['number'][$i].'</td>'
							.			'<td>'.$size[0].'</td>'
							.		'</tr>';
					}
					$table .= '</tbody></table>';
					echo $table;
				}
				
				if (isset($design->images)) {
					$images = json_decode(str_replace('&quot;', '"', $design->images), true);
					if (count($images) > 0) {
						$img = '';
						foreach ($images as $view => $src) {
							$img .= '<div class="img-thumbnail" style="margin:2px;text-align:center;"><img style="width:100px;" src="'.$base_url.'/tshirtecommerce/'.$src.'" alt="" title=""><br />'
								. '<a style="width:100%" href="'.$base_url.'/tshirtecommerce/design.php?key='.$design->rowid.'&view='.$view.'&session_id='.session_id().'" target="_blank" class="pull-right" title="'.$tshirtecommerce_link_title_download.'">'.$tshirtecommerce_link_text_download.'</a></div>';
						}
						echo $img;
					}
				}
		 	} ?>
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/account/account.php,system/storage/modification/catalog/controller/account/account.php">
		<operation error="skip">
			<search position="after"><![CDATA[$data['credit_cards'] = array();]]></search>
			<add><![CDATA[
				$logged = array(
					'login' => true,
					'email' => $this->customer->getEmail(),
					'id' => $this->customer->isLogged()
				);
				$_SESSION['is_logged'] = $logged;
				$this->session->data['is_logged'] = $logged;
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/checkout/login.php,system/storage/modification/catalog/controller/checkout/login.php">
		<operation error="skip">
			<search position="before"><![CDATA[$activity_data = array(]]></search>
			<add><![CDATA[
				$logged = array(
					'login' => true,
					'email' => $this->customer->getEmail(),
					'id' => $this->customer->getId()
				);
				$_SESSION['is_logged'] = $logged;
				$this->session->data['is_logged'] = $logged;
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/account/logout.php,system/storage/modification/catalog/controller/account/logout.php">
		<operation error="skip">
			<search position="after"><![CDATA[$this->customer->logout();]]></search>
			<add><![CDATA[
				unset($_SESSION['is_logged']);
				unset($this->session->data['is_logged']);
			]]></add>
		</operation>
	</file>
	<file name="catalog/model/catalog/product.php,system/storage/modification/catalog/model/catalog/product.php">
		<operation error="skip">
			<search position="after"><![CDATA[$query->row['product_id'],]]></search>
			<add><![CDATA[ 
				'design_product_id' => $query->row['design_product_id'],
				'design_product_title_img' => $query->row['design_product_title_img'],
			]]></add>
		</operation>		
	</file>
	<file name="catalog/controller/product/product.php,system/storage/modification/catalog/controller/product/product.php">
		<operation error="skip">
			<search position="before" index="1"><![CDATA[$this->load->model('catalog/review')]]></search>
			<add><![CDATA[
				if (!defined('DS')) define('DS', DIRECTORY_SEPARATOR);
				if (!defined('ROOT')) define('ROOT', dirname(DIR_SYSTEM).DS.'tshirtecommerce');

				include_once ROOT.DS.'includes'.DS.'functions.php';
				include_once ROOT.DS.'includes'.DS.'addons.php';
				$addons = new addons();

				$this->load->language('common/language');
				$this->load->model('localisation/language');
				$data['languages'] = array();
				$results = $this->model_localisation_language->getLanguages();
				foreach ($results as $result) {
					if ($result['status']) {
						$data['languages'][] = array(
							'name' => $result['name'],
							'code' => $result['code'],
							'tshirtecommerce_custom_text' => 'Custom Your Design'
						);
					}
				}
				$tshirtecommerce_customize_design_text = $this->config->get('tshirtecommerce_customize_design_text');
				if (null !== $tshirtecommerce_customize_design_text && !empty($tshirtecommerce_customize_design_text)) {
					if (!is_array($tshirtecommerce_customize_design_text)) {
						$tshirtecommerce_customize_design_texts = @json_decode($tshirtecommerce_customize_design_text, true);
					} else {
						$tshirtecommerce_customize_design_texts = $tshirtecommerce_customize_design_text;
					}
					if(count($tshirtecommerce_customize_design_texts))
					{
						foreach ($data['languages'] as &$language) {
							foreach ($tshirtecommerce_customize_design_texts as $key => $value) {
								if ($language['code'] == $key) $language['tshirtecommerce_custom_text'] = $value;
							}
						}
					}
				}
				foreach ($data['languages'] as &$language) {
					if ($this->session->data['language'] == $language['code']) {
						$data['tshirtecommerce_button_custom_your_design'] = $language['tshirtecommerce_custom_text'];
					}
				}

				$data['tshirtecommerce_label_price_of_print'] = $addons->__('tshirtecommerce_label_price_of_print');
				$data['tshirtecommerce_warning_alert_order'] = $addons->__('tshirtecommerce_warning_alert_order');
				$data['tshirtecommerce_printing_type'] = $addons->__('tshirtecommerce_printing_type');
				$data['oc_quantity'] = isset($product_info['quantity']) ? $product_info['quantity'] : 0;
				$data['oc_minimum'] = isset($product_info['minimum']) ? $product_info['minimum'] : 0;
				$data['design_product_id'] = isset($product_info['design_product_id']) ? $product_info['design_product_id'] : '';
				$data['design_product_color'] = $addons->__('designer_color');

				if (isset($product_info['design_product_title_img'])) {
					$data['design_product_title_img'] = $product_info['design_product_title_img'];
					$temp = explode('::', $data['design_product_title_img']);
					if (isset($temp[2])) {
						if ($data['design_product_id'] != '') {
							$data['design_print_price'] = (float)$temp[2];
							$data['design_print_price_lable'] = $this->currency->format($data['design_print_price'], $this->session->data['currency']);
						} else {
							$data['design_print_price'] = 0;
						}
					} else {
						$data['design_print_price'] =  0;
					}
				} else {
					$data['design_product_title_img'] =  '';
					$data['design_print_price'] =  0;
				}

				$this->load->model('setting/setting');
				if (null !== $this->config->get('tshirtecommerce_customize_design_btn')) {
					$data['tshirtecommerce_customize_design_btn'] = $this->config->get('tshirtecommerce_customize_design_btn');
				} else {
					$data['tshirtecommerce_customize_design_btn'] = 'color: #ffffff;text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);background-color: #5bb75b;background-image: linear-gradient(to bottom, #62c462, #51a351);background-repeat: repeat-x;border-color: #51a351 #51a351 #387038;padding: 10px 16px;font-size: 15px;border-radius: 4px;box-shadow: inset 0 1px 0 rgba(255,255,255,.2), 0 1px 2px rgba(0,0,0,.05);width: 100%;display: block;line-height: 1.3333333;font-weight: 400;text-align: center;';
				}

				if (null !== $this->config->get('tshirtecommerce_hide_addtocart')) {
					$data['tshirtecommerce_hide_addtocart'] = $this->config->get('tshirtecommerce_hide_addtocart');
				} else {
					$data['tshirtecommerce_hide_addtocart'] = 0;
				}

				if (isset($this->request->server['HTTPS']) && (($this->request->server['HTTPS'] == 'on') || ($this->request->server['HTTPS'] == '1'))) {
		         	$site_url = $this->config->get('config_ssl');
			    } else {
			        $site_url = $this->config->get('config_url');
			    }
			    $data['site_url'] = $site_url;

			    $rates_info = $this->tax->getRates(1, $product_info['tax_class_id']);
			    $amount = 0;
				foreach ($rates_info as $rates) {
					if ($rates['type'] == 'P') $amount += $rates['amount'];
				}
				$otaxes = $amount;
			    if ($otaxes === false) $otaxes = 0;
				$data['otaxes'] = $otaxes;
			]]></add>
		</operation>		
	</file>
	<file name="catalog/view/theme/*/template/product/product.tpl,system/storage/modification/catalog/view/theme/*/template/product/product.tpl">
		<operation error="skip">
			<search position="before"><![CDATA[id="button-cart"]]></search>
			<add><![CDATA[
				<?php $e_validate_input_order = false; ?>
				<ul class="list-unstyled">
					<?php
						$design_product_id_arr = explode(':', $design_product_id);
						$e_design_product_id = 0;
						$e_design_product_id = (count($design_product_id_arr) > 1) ? (isset($design_product_id_arr[2]) ? $design_product_id_arr[2] : 0) : $design_product_id;

						$file = dirname(DIR_SYSTEM).'/tshirtecommerce/data/products.json';
						if (file_exists($file)) {			
							$string = file_get_contents($file);
							if ($string != false) {
								$e_products = json_decode($string);
								if (isset($e_products->products) && count($e_products->products) > 0) {
									foreach ($e_products->products as $values) {
										if (isset($e_design_product_id) && $e_design_product_id != '' && $e_design_product_id == $values->id && isset($values->show_attribute)) { ?>
											<div class="row designer-attributes">
												<link href="<?php echo $site_url; ?>/tshirtecommerce/opencart/css/product.css" rel="stylesheet">
												<script src="<?php echo $site_url; ?>/tshirtecommerce/opencart/js/product.js"></script>
												<?php if(isset($values->design) && isset($values->design->color_hex)) { ?>
													<p><strong><?php echo $design_product_color; ?></strong></p>
													<div class='list-colors' style='margin-bottom:15px;'>
														<?php $color_hex_idx = 0; ?>
														<?php foreach ($values->design->color_hex as $ck => $ch) { ?>
														<?php if ($ch == $tshirtecommerce_color) { ?>
														<?php $color_hex_idx = $ck; ?>
														<a href="<?php echo $tcolor_link; ?>&color=<?php echo $ch; ?>" data-color="<?php echo $ch; ?>" data-index="<?php echo $ck ?>" class="bg-colors active" title="<?php echo $values->design->color_title[$ck] ?>"><span style="width:24px;background-color:#<?php echo $ch ?>;"></span></a>
														<?php } else { ?>
														<a href="<?php echo $tcolor_link; ?>&color=<?php echo $ch; ?>" data-color="<?php echo $ch; ?>" data-index="<?php echo $ck ?>" class="bg-colors" title="<?php echo $values->design->color_title[$ck] ?>"><span style="width:24px;background-color:#<?php echo $ch ?>;"></span></a>
														<?php } ?>
														<?php } ?>
														<input type='hidden' value='<?php echo (isset($design_product_id_arr[0]) ? $design_product_id_arr[0] : '') ?>' name='design[rowid]' id='e_rowid' />
														<input type="hidden" value="<?php echo $tshirtecommerce_color; ?>" id='e_color_hex' name="design[color_hex]" />
														<input type="hidden" value="<?php echo $values->design->color_title[$color_hex_idx] ?>" name="design[color_title]" />
														<input type="hidden" value="<?php echo $values->id ?>" name="design_product_id" />
														<input type="hidden" value="<?php echo $values->id ?>" name="design[design_product_id]" />
														<input type="hidden" value="" name="design[images]" />
														<input type="hidden" value="1" name="design[idea]" />
													</div>
												<?php }
												if (isset($values->show_attribute) && $values->show_attribute == 1 && ! empty($values->attributes)) {
													$e_validate_input_order = true; ?>
													<div class='product-attributes'>
														<input type='hidden' value='<?php echo $oc_minimum ?>' id='e-input-min-order' />
														<input type='hidden' value='<?php echo $oc_quantity ?>' id='e-input-max-order' />
														<?php $e_attr_count = count($values->attributes->name);
														echo '<input type="hidden" value="'.$product_id.'" name="design[product_id]" />';
														for ($ia = 0; $ia < $e_attr_count; $ia++) { ?>
															<div class='form-group product-fields' style='margin-bottom:0!important'><p><strong><?php echo $values->attributes->name[$ia] ?></strong></p></div>
															<div class='dg-poduct-fields'>
																<input type='hidden' value='<?php echo $values->attributes->name[$ia] ?>' name='design[options][<?php echo $ia ?>][name]' />
																<input type='hidden' value='<?php echo $values->attributes->type[$ia] ?>' name='design[options][<?php echo $ia ?>][type]' />
																<?php switch ($values->attributes->type[$ia]) {
																	case 'textlist':
																		echo "<script>document.getElementsByName('quantity')[0].disabled = true;</script><ul id='e-input-options' class='p-color-sizes list-number col-md-12' style='width:100%'>";
																		$iaj = 0;
																		foreach ($values->attributes->titles[$ia] as $value) {
																			echo "<li style='padding-bottom:10px'>";
																			echo "<label>";
																			if (isset($values->attributes->prices[$ia][$iaj]) && $values->attributes->prices[$ia][$iaj] > 0) {
																				$values->attributes->prices[$ia][$iaj] += $values->attributes->prices[$ia][$iaj]*$otaxes;
																				echo $value.'(+'.$values->attributes->prices[$ia][$iaj].')';
																			} elseif (isset($values->attributes->prices[$ia][$iaj]) && $values->attributes->prices[$ia][$iaj] < 0) {
																				$values->attributes->prices[$ia][$iaj] += $values->attributes->prices[$ia][$iaj]*$otaxes;
																				echo $value.'(-'.$values->attributes->prices[$ia][$iaj].')';
																			} else {
																				echo $value;
																			}
																			echo "</label>";
																			if ($iaj == 0) {
																				echo "<input type='text' class='form-control input-sm size-number' name='design[options][$ia][value][$value]' value='$oc_minimum' onchange='e_tshirt_attributes(this, $iaj)' onkeypress='return e_validate_num(event, this)' />";
																			} else {
																				echo "<input type='text' class='form-control input-sm size-number' name='design[options][$ia][value][$value]' value='0' onchange='e_tshirt_attributes(this, $iaj)' onkeypress='return e_validate_num(event, this)' />";
																			}
																			echo "<input type='hidden' name='design[options][$ia][price][$value]' value='".(isset($values->attributes->prices[$ia][$iaj]) ? $values->attributes->prices[$ia][$iaj] : 0)."' />";
																			$iaj++;
																		}
																		break;

																	case 'checkbox':
																		$iaj = 0;
																		echo "<div class='form-group'>";
																		foreach ($values->attributes->titles[$ia] as $value) {
																			echo '<p><label class="checkbox-inline">';
																			if (isset($values->attributes->prices[$ia][$iaj]) && $values->attributes->prices[$ia][$iaj] > 0) {
																				$values->attributes->prices[$ia][$iaj] += $values->attributes->prices[$ia][$iaj]*$otaxes;
																				echo "<input type='checkbox' name='design[options][$ia][value][$iaj]' value='$value' />";
																				echo $value .'(+'.$values->attributes->prices[$ia][$iaj].')';
																			} elseif (isset($values->attributes->prices[$ia][$iaj]) && $values->attributes->prices[$ia][$iaj] < 0) {
																				$values->attributes->prices[$ia][$iaj] += $values->attributes->prices[$ia][$iaj]*$otaxes;
																				echo "<input type='checkbox' name='design[options][$ia][value][$iaj]' value='$value' />";
																				echo $value .'(-'.$values->attributes->prices[$ia][$iaj].')';
																			} else {
																				echo "<input type='checkbox' name='design[options][$ia][value][$iaj]' value='$value' />";
																				echo $value;
																			}
																			echo '</label></p>';
																			$iaj++;
																		}
																		echo '</div>';
																		break;

																	case 'selectbox':
																		$iaj = 0;
																		echo "<div class='form-group'>";
																		echo "<select class='form-control input-sm' name='design[options][$ia][value]'>";
																		foreach ($values->attributes->titles[$ia] as $value) {
																			if (isset($values->attributes->prices[$ia][$iaj]) && $values->attributes->prices[$ia][$iaj] > 0) {
																				$values->attributes->prices[$ia][$iaj] += $values->attributes->prices[$ia][$iaj]*$otaxes;
																				echo "<option value='$value'>$value (+".$values->attributes->prices[$ia][$iaj].")</option>";
																			} elseif (isset($values->attributes->prices[$ia][$iaj]) && $values->attributes->prices[$ia][$iaj] < 0) {
																				$values->attributes->prices[$ia][$iaj] += $values->attributes->prices[$ia][$iaj]*$otaxes;
																				echo "<option value='$value'>$value (-".$values->attributes->prices[$ia][$iaj].")</option>";
																			} else {
																				echo "<option value='$value'>$value</option>";
																			}
																			$iaj++;
																		}
																		echo '</select>';
																		echo '</div>';
																		break;

																	case 'radio';
																		$iaj = 0;
																		echo "<div class='form-group'>";
																		foreach ($values->attributes->titles[$ia] as $value) {
																			echo '<p><label class="radio-inline">';
																			if (isset($values->attributes->prices[$ia][$iaj]) && $values->attributes->prices[$ia][$iaj] > 0) {
																				$values->attributes->prices[$ia][$iaj] += $values->attributes->prices[$ia][$iaj]*$otaxes;
																				echo "<input type='radio' value='$value' name='design[options][$ia][value]' />";
																				echo $value .'(+'.$values->attributes->prices[$ia][$iaj].')';
																			} elseif (isset($values->attributes->prices[$ia][$iaj]) && $values->attributes->prices[$ia][$iaj] < 0) {
																				$values->attributes->prices[$ia][$iaj] += $values->attributes->prices[$ia][$iaj]*$otaxes;
																				echo "<input type='radio' value='$value' name='design[options][$ia][value]' />";
																				echo $value .'(-'.$values->attributes->prices[$ia][$iaj].')';
																			} else {
																				echo "<input type='radio' value='$value' name='design[options][$ia][value]' />";
																				echo $value;
																			}
																			echo '</label></p>';
																			$iaj++;
																		}
																		echo '</div>';
																		break;

																	default:
																		break;
																} ?>
															</div>
														<?php } 
														echo '<input type="hidden" value="'.$tshirtecommerce_printing_type.'" name="design[options]['.$e_attr_count.'][name]" />';
														echo '<input type="hidden" value="printing" name="design[options]['.$e_attr_count.'][type]" />';
														echo '<input type="hidden" value="'. $values->print_type .'" name="design[options]['.$e_attr_count.'][value]" />';
														echo '<input type="hidden" value="'. $values->print_type .'" name="design[design_printing]" />'; ?>
													</div>
													<div class='clear:both;'></div>
												<?php } ?>
											</div>
										<?php }
									}
								}
							}
						} ?>
				</ul>
				<?php if (isset($design_product_id) && $design_product_id != '') {
					$check_idea = explode(':', $design_product_id);
					$parent_id 	= $product_id;
					if (count($check_idea) > 1) {
						if (isset($design_print_price) && $design_print_price != 0) { ?>
							<p><label class="control-label"><?php echo $tshirtecommerce_label_price_of_print; ?> <strong>+<?php echo $design_print_price_lable; ?></strong></label></p>
						<input name='design[oc_price_of_print]' type='hidden' value='<?php echo $design_print_price ?>' />
						<?php }
					} ?>
					<div style='clear:both'></div>
					<?php if (isset($tshirtecommerce_hide_addtocart) && $tshirtecommerce_hide_addtocart == 1) { ?>
						<style>#button-cart{display:none !important;}</style>
					<?php }
					$tscheck_class = explode(':', $tshirtecommerce_customize_design_btn);
					if (count($tscheck_class) > 1) { ?>
						<p><a id="button-design" style='<?php if(isset($tshirtecommerce_customize_design_btn)) echo $tshirtecommerce_customize_design_btn; ?>' href="<?php echo $tshirtecommerce_designer_link; ?>"><?php echo $tshirtecommerce_button_custom_your_design; ?></a>
						</p>
					<?php } else { ?>
						<p><a id="button-design" class='<?php if(isset($tshirtecommerce_customize_design_btn)) echo $tshirtecommerce_customize_design_btn; ?>' href="<?php echo $tshirtecommerce_designer_link; ?>"><?php echo $tshirtecommerce_button_custom_your_design; ?></a>
						</p>
					<?php }
				} ?>
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/checkout/cart.php,system/storage/modification/catalog/controller/checkout/cart.php">
		<operation error="skip">
			<search position="before"><![CDATA[$data['products'][] = array(]]></search>
			<add><![CDATA[
				if (!defined('DS')) define('DS', DIRECTORY_SEPARATOR);
				if (!defined('ROOT')) define('ROOT', dirname(DIR_SYSTEM).DS.'tshirtecommerce');
				include_once ROOT.DS.'includes'.DS.'functions.php';
				include_once ROOT.DS.'includes'.DS.'addons.php';
				$addons = new addons();

				$data['tshirtecommerce_designer_cart_edit'] = $addons->__('designer_cart_edit');
				$data['tshirtecommerce_printing_type'] = $addons->__('tshirtecommerce_printing_type');
				if (isset($product['design']) && $product['design'] != false && isset($product['design']['rowid'])) {					
					$design = $product['design'];
					$item = $this->db->query("
						SELECT `product_id`, `design_product_id` 
						FROM `".DB_PREFIX."product` 
						WHERE `status` = 1 AND `product_id` = '".$product['design']['product_id']."'
					");
					$design_product_id = 0;
					if ($item->num_rows) $design_product_id = $item->row['design_product_id'];
					$keys = explode(':', $design_product_id);
					if (count($keys) > 1 && isset($keys[3]) && isset($design['color_hex'])) {
						$keys[3] = $design['color_hex'];
						$design_product_id = $keys[0].':'.$keys[1].':'.$keys[2].':'.$keys[3];
					}
					$product['design']['design_product_id'] = $design_product_id;

					if (isset($design['images'])) {
						$images = json_decode(str_replace('&quot;', '"', $design['images']), true);
						if (count($images) > 0) {
							$base_url = (isset($this->request->server['HTTPS']) && (($this->request->server['HTTPS'] == 'on') || ($this->request->server['HTTPS'] == '1'))) ? $this->config->get('config_ssl') : $this->config->get('config_url');
							$img = '';
							foreach ($images as $view => $src) {
								$img .= '<a href="'.$base_url.'/tshirtecommerce/'.$src.'"><img style="width:100px; margin:1%;" src="'.$base_url.'/tshirtecommerce/'.$src.'" alt="" title="" class="img-thumbnail"></a>';
							}
							$design_option = array(
								'name'	=> 'Images',
								'value'	=> '<br /><div>'.$img.'</div>'
							);
							$option_data[] = $design_option;
						}
					}

					$design_option = array(
						'name' => 'Color',
						'value'	=> '<span title="'.$design['color_title'].'" style="background-color:#'.$design['color_hex'].';display:inline-block;border:1px solid #ccc;width:25px;height:25px;cursor:pointer;outline:1px solid #229BCA;margin-left 4px;"></span>'
					);
					$option_data[] = $design_option;
					if (isset($design['options']) && $design['options'] != '[]') {
						$design_options = is_string($design['options']) ? json_decode(str_replace('&quot;', '"', $design['options'])) : $design['options'];
						$html = '';
						for ($i = 0; $i < count($design_options); $i++) {
							if (empty($design_options[$i]['value'])) continue;
							if (is_string($design_options[$i]['value']) && !empty($design_options[$i]['value'])) {
								if (empty($design_options[$i]['name']) && $design_options[$i]['type'] == 'printing') {
									$design_options[$i]['name'] = $data['tshirtecommerce_printing_type'];
								}
								$html .= '<dt>'.$design_options[$i]['name'].': '.$design_options[$i]['value'].'</dt>';
							} elseif (count($design_options[$i]['value']) > 0) {
								$html .= '<dt>'.$design_options[$i]['name'].': </dt>';
								$html .=  '<dd>';
								foreach ($design_options[$i]['value'] as $name => $value) {
									if ($design_options[$i]['type'] == 'checkbox') {
										$html .=  $value. '; ';
									} else {
										if ($value != '0' && $value != 0) {
											$html .=  $name.'  -  '.$value. '; ';
										}
									}
								}
								$html .=  '</dd>';
							}
						}
						$design_option = array(
							'name'	=> 'Options',
							'value'	=> $html
						);
						$option_data[] = $design_option;
					}
					// teams
					if (isset($design['teams']) && isset($design['teams']['name'])) {
						$table = '<table class="table table-bordered">'
							. 		'<thead>'
							. 			'<tr>'
							. 				'<th>Name</th>'
							. 				'<th>Number</th>'
							. 				'<th>Sizes</th>'
							. 			'</tr>'
							. 		'</thead>'
							. 		'<tbody>';
						for ($i = 1; $i <= count($design['teams']['name']); $i++) {
							$size = explode('::', $design['teams']['size'][$i]);
							$table .=	'<tr>'
								.			'<td>'.$design['teams']['name'][$i].'</td>'
								.			'<td>'.$design['teams']['number'][$i].'</td>'
								.			'<td>'.$size[0].'</td>'
								.		'</tr>';
						}
						$table .= '</tbody></table>';
						$design_option = array(
							'name'	=> 'Team',
							'value'	=> $table
						);
						$option_data[] = $design_option;
					}
				} else {
					$design = '';					
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[$data['products'][] = array(]]></search>
			<add><![CDATA[
				'order_id' => (isset($product['design']['rowid']) ? $product['design']['rowid'] : 0),
				'parent_id' => (isset($product['design']['product_id']) ? $product['design']['product_id'] : 0),
				'design_product_id' => (isset($design_product_id) ? $design_product_id : 0),
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[isset($this->request->post['option'])]]></search>
			<add><![CDATA[
				if (isset($this->request->post['design']) && isset($this->request->post['design']['options'])) {
					$teoptions = $this->request->post['design']['options'];
					if (!defined('DS')) {
						define('DS', DIRECTORY_SEPARATOR);
					}
			        if (!defined('ROOT')) {
			        	define('ROOT', dirname(DIR_SYSTEM).DS.'tshirtecommerce');
			        }
			        include_once(ROOT.'/includes/functions.php');
			        $tdg = new \dg();
			        $tproduct_design_ids = $this->db->query("
						SELECT `design_product_id` 
						FROM `".DB_PREFIX."product` 
						WHERE `status` = 1 AND `product_id` = '".(int)$this->request->post['design']['product_id']."'
					");
					$teattributes = array();
					$tproduct_design_id = $tproduct_design_ids->row['design_product_id'];
					$tproduct_design_id_arr = explode(':', $tproduct_design_id);
					$tdesign_id = isset($tproduct_design_id_arr[1]) ? $tproduct_design_id_arr[1] : '';
					$tcache = $tdg->cache('admin');
					$tdesigns = $tcache->get($this->request->post['design']['rowid']);
					if (!empty($tdesign_id)) {
						$ttdesign = isset($tdesigns[$tdesign_id]) ? $tdesigns[$tdesign_id] : false;

						if ($ttdesign == false) {
							$tcache = $tdg->cache('design');
							$tdesigns = $tcache->get($this->request->post['design']['rowid']);
							$ttdesign = isset($tdesigns[$tdesign_id]) ? $tdesigns[$tdesign_id] : false;
						}
						if ($ttdesign !== false) {
							$teattributes['colors'] = $ttdesign['colors'];
							$teattributes['print'] = $ttdesign['print'];
							$teattributes['cliparts'] = $ttdesign['cliparts'];
							$teattributes['product_id'] = $ttdesign['product_id'];
							$tartStore = array();
							$evector = isset($ttdesign['vector']) ? $ttdesign['vector'] : '';
				            if (!empty($evector)) {
				                $json_evector = @json_decode($evector, true);
				                if (count($json_evector)) {
				                    foreach ($json_evector as $view => $items) {
				                        if (count($items)) {
				                            foreach ($items as $item) {
				                                if (isset($item['clipar_type']) && $item['clipar_type'] == 'store') {
				                                    $tartStore[] = $item['clipart_id'];
				                                }
				                            }
				                        }
				                    }
				                }
				            }
							$teattributes['artStore'] = $tartStore;

							if (!isset($ttdesign['attribute'])) $ttdesign['attribute'] = array();

							$tfile = dirname(DIR_SYSTEM).'/tshirtecommerce/data/products.json';
							$tstring = @file_get_contents($tfile);
							$eproducts = array();
							if ($tstring != false) {
								$tproducts = @json_decode($tstring, true);
								if (count($tproducts) > 0) {
									$eproducts = $tproducts['products'];
								}
							}
							$eattributes = array();
							foreach ($eproducts as $eproduct) {
								if ($eproduct['id'] == $this->request->post['design']['design_product_id']) {
									$eattributes = $eproduct['attributes'];
								}
							}
							$tattributes = array();
							foreach ($teoptions as $tkey => $tvalue) {
								switch ($tvalue['type']) {
									case 'checkbox':
										$ttemp = array();
										foreach ($tvalue['value'] as $ttkey => $ttvalue) {
											$ttemp[$ttkey] = $ttkey;
										}
										$tattributes[$tkey] = $ttemp;
										break;
									case 'selectbox':
									case 'radio':
											if (isset($eattributes['titles'][$tkey]) && count($eattributes['titles'][$tkey]) > 0) {
												foreach ($eattributes['titles'][$tkey] as $tttkey => $tttvalue) {
													if ($tttvalue == $tvalue['value']) {
														$tattributes[$tkey] = $tttkey;
													}
												}
											}
										break;
									case 'textlist':
										foreach ($tvalue['value'] as $ttkey => $ttvalue) {
											if (count($ttvalue) > 0) {
												if (isset($eattributes['titles'][$tkey]) && count($eattributes['titles'][$tkey]) > 0) {
													foreach ($eattributes['titles'][$tkey] as $tttkey => $tttvalue) {
														if ($tttvalue == $ttkey && $ttvalue > 0) {
															$tattributes[$tkey][$tttkey] = $ttvalue;
														}
													}
												}
											}
										}
										break;
									default:
										break;
								}
							}
							$teattributes['attribute'] = $tattributes;
						}
					} else {
						include dirname(DIR_SYSTEM).'/tshirtecommerce/opencart/includes/cart_blank.php';
					}
					$this->session->data[$this->request->post['design']['rowid']] = $teattributes;
				}
				if (isset($this->request->post['design']) && isset($this->request->post['design']['option_oc'])) {
					if (isset($this->request->post['design']['tattributes']) && isset($this->request->post['design']['rowid'])) {
						$this->session->data[$this->request->post['design']['rowid']] = $this->request->post['design']['tattributes'];
					}
					$this->load->model('catalog/product');
					$optoins_oc = $this->model_catalog_product->getProductOptions($product_id);
					$_options = array();
					$str_option_oc = str_replace('&quot;', '"', $this->request->post['design']['option_oc']);
					$temp_design_option_oc = array();
					$temp_option_oc = explode(';;', $str_option_oc);
					foreach ($temp_option_oc as $topc) {
						if (!empty($topc)) {
							$tstr = explode('::', $topc);
							if (count($tstr) > 1) {
								$is_tcheckbox = false;
								foreach ($optoins_oc as $op_oc) {
									if ($op_oc['product_option_id'] == $tstr[0] && $op_oc['type'] == 'checkbox') {
										$is_tcheckbox = true;
										break;
									}
								}
								if ($is_tcheckbox === false) {
									$temp_design_option_oc[$tstr[0]] = $tstr[1];
								} else {
									$ttmp = explode(',', $tstr[1]);
									if (count($ttmp) > 1) {
										foreach ($ttmp as $ttmp_value) {
											$temp_design_option_oc[$tstr[0]][] = $ttmp_value;
										}
									} else {
										$temp_design_option_oc[$tstr[0]][] = $tstr[1];
									}
								}
							}
						}
					}
					$this->request->post['option'] = $temp_design_option_oc;
				}
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/checkout/confirm.php,system/storage/modification/catalog/controller/checkout/confirm.php">
		<operation error="skip">
			<search position="before"><![CDATA[$order_data['products'][] = array(]]></search>
			<add><![CDATA[
				if (isset($product['design'])) {
					$design_product_id = '';
					if (isset($product['design']['product_id'])) {
						$item = $this->db->query("
							SELECT product_id, design_product_id 
							FROM `".DB_PREFIX."product` 
							WHERE status = 1 AND product_id = '".$product['design']['product_id']."'
						");
						if ($item->num_rows) {
							$design_product_id = $item->row['design_product_id'];
						}
					}
					$product['design']['design_product_id'] = $design_product_id;
					$design = json_encode($product['design']);
				} else {
					$design = '';
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[$this->tax->getTax($product['price'], $product['tax_class_id']),]]></search>
			<add><![CDATA[
			'design' => $design,
			]]></add>
		</operation>
	</file>
	<file name="catalog/model/checkout/order.php,system/storage/modification/catalog/model/checkout/order.php">
		<operation error="skip">
			<search position="after" index="1"><![CDATA[$order_product_id = $this->db->getLastId();]]></search>
			<add><![CDATA[
				if (isset($product['design']) && !empty($product['design'])) {
					$this->db->query("
						INSERT INTO ".DB_PREFIX."tshirtdesign_order 
						SET order_product_id = '".(int)$order_product_id."', options = '".$this->db->escape($product['design'])."'
					");
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[$data = array();]]></search>
			<add><![CDATA[
				$this->load->model('tshirtecommerce/order');
				$base_url = (isset($this->request->server['HTTPS']) && (($this->request->server['HTTPS'] == 'on') || ($this->request->server['HTTPS'] == '1'))) ? $this->config->get('config_ssl') : $this->config->get('config_url');

				$data['base_url'] = $base_url;
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[$data['products'][] = array(]]></search>
			<add><![CDATA[
				if (!defined('DS')) define('DS', DIRECTORY_SEPARATOR);
				if (!defined('ROOT')) define('ROOT', dirname(DIR_SYSTEM).DIRECTORY_SEPARATOR.'tshirtecommerce');
				if (file_exists(ROOT.DS.'includes'.DS.'functions.php')) {
					include_once ROOT.DS.'includes'.DS.'functions.php';
					$dg = new dg();
					include_once ROOT.DS.'includes'.DS.'addons.php';
					$addons = new addons();

					$data['tshirtecommerce_designer_cart_edit'] 		= $addons->__('designer_cart_edit');
					$data['tshirtecommerce_link_text_download'] 		= $addons->__('tshirtecommerce_link_text_download');
					$data['tshirtecommerce_link_title_download'] 		= $addons->__('tshirtecommerce_link_title_download');
					$data['tshirtecommerce_link_title_edit'] 			= $addons->__('tshirtecommerce_link_title_edit');
					$data['tshirtecommerce_view_front'] 				= $addons->__('tshirtecommerce_view_front');
					$data['tshirtecommerce_view_left'] 					= $addons->__('tshirtecommerce_view_left');
					$data['tshirtecommerce_view_right'] 				= $addons->__('tshirtecommerce_view_right');
					$data['tshirtecommerce_view_back'] 					= $addons->__('tshirtecommerce_view_back');
					$data['ts_designer_clipart_edit_name'] 				= $addons->__('designer_clipart_edit_name');
					$data['ts_designer_clipart_edit_number'] 			= $addons->__('designer_clipart_edit_number');
					$data['tshirtecommerce_head_text_sizes'] 			= $addons->__('tshirtecommerce_head_text_sizes');
					$data['tshirtecommerce_link_view_design'] 			= $addons->__('tshirtecommerce_link_view_design');
					$data['tshirtecommerce_label_or_download_design'] 	= $addons->__('tshirtecommerce_label_or_download_design');
					$data['tshirtecommerce_label_color'] 				= $addons->__('tshirtecommerce_label_color');
					$data['tshirtecommerce_printing_type'] 				= $addons->__('tshirtecommerce_printing_type');
				}
				$this->load->model('setting/setting');

				$data['tshirtecommerce_downloadable'] = (null !== $this->config->get('tshirtecommerce_downloadable')) ? $this->config->get('tshirtecommerce_downloadable') : 0;

				$this->load->model('catalog/product');
				$e_products = $this->model_catalog_product->getProduct($product['product_id']);
				$design_product_id 	= (isset($e_products) && isset($e_products['design_product_id'])) ? $e_products['design_product_id'] : '';

				$settings = $dg->getSetting();
				$data['store_enable'] = isset($settings->store->enable) ? $settings->store->enable : 0;

				$_data = $this->model_tshirtecommerce_order->getItem($product['order_product_id'], $product['product_id']);
				$chk_return = false;
				$store_setting = array();
				$store_temp = array();
				$msg_store_empty = '';
				if (isset($dg) && $_data !== false && isset($_data->rowid)) {
					$cache = $dg->cache('cart');
					$design = $cache->get($_data->rowid);
					$order_item = $design['item'];
					$arts = array();
					$prices = 0;
					$qty = (int) ($order_item['qty'] / 10);
					if($qty < 1) $qty = 1;

					if (isset($design['vector'])) {
						$ids = array();
						$vectors = json_decode($design['vector'], true);
						if (count($vectors)) {
							foreach ($vectors as $view => $items) {
								if (count($items)) {
									foreach ($items as $item) {
										if (isset($item['clipar_type']) && empty($item['clipar_paid'])) {
											if (empty($item['price'])) $item['price'] = 0;
											if (is_string($item['file'])) $file = $item['file'];
											if (isset($item['file']['type'])) $file = $item['file']['type'];
											$arts[$item['clipart_id']] = array(
												'view' => $view,
												'id' => $item['clipart_id'],
												'title'	=> $item['title'],
												'thumb'	=> $item['thumb'],
												'file' => $file,
												'price'	=> $item['price'],
											);
											if (!in_array($item['clipart_id'].'-'.$qty, $ids)) {
												$prices = $prices + ($item['price'] * $qty);
												$ids[] 	= $item['clipart_id'].'-'.$qty;
											}
										}
									}
									// update info after paid
									if (isset($this->request->get['e_order_id']) && isset($this->request->get['params']) 
										&& count($ids) > 0 && $data['design_id'] == $this->request->get['e_order_id']) {
										$e_order_id = $this->request->get['e_order_id'];
										$params = $this->request->get['params'];
										$settings = $dg->getSetting();
										$api = $settings->store->api;
										store_art_update($e_order_id, $params, array(), $api);
										$chk_return = true;
									}
								}
							}
						}
					}
					if (count($arts) && $chk_return == false) {
						$settings = $dg->getSetting();
						if (empty($settings->store)) {
							$msg_store_empty = '<p style="background-color: #fcf8e3;color:#8a6d3b;border: 1px solid #faebcc;padding:14px 12px;margin: 0px;">Your order using arts of <a href="http://store.9file.net/" target="_blank">store</a>. You missing setup API Store. Please go to <strong>T-Shirt eCommerce > Settings > Configuration > Tab Config</strong> setup store to download file output.</p>';
						} elseif (empty($settings->store->api) || (isset($settings->store->api) && $settings->store->api == '')) {
							$msg_store_empty = '<p style="background-color: #fcf8e3;color:#8a6d3b;border: 1px solid #faebcc;padding:14px 12px;margin: 0px;">Your order using arts of <a href="http://store.9file.net/" target="_blank">store</a>. You missing setup API Store. Please go to <strong>T-Shirt eCommerce > Settings > Configuration > Tab Config</strong> setup store to download file output.</p>';
						} else {
							$api = $settings->store->api;
							$store_temp['api'] = $api;
							$store_temp['ids'] = $ids;
							$store_temp['ids'] = $ids;
							$store_temp['prices'] = $prices;
							$store_temp['arts'] = $arts;
							$store_temp['qty'] = $qty;
						}
					}
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[$data['products'][] = array(]]></search>
			<add><![CDATA[
				'design' => $this->model_tshirtecommerce_order->getItem($product['order_product_id'], $product['product_id']),
				'link_edit' => 'index.php?route=tshirtecommerce/designer&product_id=',
				'design_product_id' => $design_product_id,
				'_design' => isset($design) ? $design : array(),
				'store_temp' => $store_temp,
				'msg_store_empty' => $msg_store_empty,
				'u_return' => $chk_return,
			]]></add>
		</operation>
	</file>
	<file name="catalog/view/theme/*/template/checkout/cart.tpl,system/storage/modification/catalog/view/theme/*/template/checkout/cart.tpl">
		<operation error="skip">
			<search position="before" index="1"><![CDATA[$product['option']]]></search>
			<add><![CDATA[
				<?php if( ! empty($product['order_id']) && $product['design_product_id'] != $product['order_id']) { ?>
					<br/>
					<a href="index.php?route=tshirtecommerce/designer&product_id=<?php echo $product['design_product_id'] ?>&parent_id=<?php echo $product['parent_id'] ?>&cart_id=<?php echo $product['order_id'] ?>" title=""><?php echo $tshirtecommerce_designer_cart_edit ?></a>
				<?php } ?>
			]]></add>
		</operation>
	</file>
	<file name="catalog/controller/account/order.php,system/storage/modification/catalog/controller/account/order.php">
		<operation error="skip">
			<search position="after"><![CDATA[$this->model_account_order->getOrderProducts($this->request->get['order_id']);]]></search>
			<add><![CDATA[
				if (!defined('DS')) define('DS', DIRECTORY_SEPARATOR);
				if (!defined('ROOT')) define('ROOT', dirname(DIR_SYSTEM).DIRECTORY_SEPARATOR.'tshirtecommerce');
				
					include_once ROOT.DS.'includes'.DS.'functions.php';
					$dg = new dg();
					include_once ROOT.DS.'includes'.DS.'addons.php';
					$addons = new addons();
					$data['tshirtecommerce_designer_cart_edit'] 		= $addons->__('designer_cart_edit');
					$data['tshirtecommerce_link_text_download'] 		= $addons->__('tshirtecommerce_link_text_download');
					$data['tshirtecommerce_link_title_download'] 		= $addons->__('tshirtecommerce_link_title_download');
					$data['tshirtecommerce_link_title_edit'] 			= $addons->__('tshirtecommerce_link_title_edit');
					$data['tshirtecommerce_view_front'] 				= $addons->__('tshirtecommerce_view_front');
					$data['tshirtecommerce_view_left'] 					= $addons->__('tshirtecommerce_view_left');
					$data['tshirtecommerce_view_right'] 				= $addons->__('tshirtecommerce_view_right');
					$data['tshirtecommerce_view_back'] 					= $addons->__('tshirtecommerce_view_back');
					$data['ts_designer_clipart_edit_name'] 				= $addons->__('designer_clipart_edit_name');
					$data['ts_designer_clipart_edit_number'] 			= $addons->__('designer_clipart_edit_number');
					$data['tshirtecommerce_head_text_sizes'] 			= $addons->__('tshirtecommerce_head_text_sizes');
					$data['tshirtecommerce_link_view_design'] 			= $addons->__('tshirtecommerce_link_view_design');
					$data['tshirtecommerce_label_or_download_design'] 	= $addons->__('tshirtecommerce_label_or_download_design');
					$data['tshirtecommerce_printing_type'] 				= $addons->__('tshirtecommerce_printing_type');
				
				$this->load->model('tshirtecommerce/order');
				$base_url = (isset($this->request->server['HTTPS']) && (($this->request->server['HTTPS'] == 'on') || ($this->request->server['HTTPS'] == '1'))) ? $this->config->get('config_ssl') : $this->config->get('config_url');
				
				$data['base_url'] = $base_url;
				$settings = $dg->getSetting();
				$data['store_enable'] = isset($settings->store->enable) ? $settings->store->enable : 0;
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[$option_data,]]></search>
			<add><![CDATA[
				'design' => $this->model_tshirtecommerce_order->getItem($product['order_product_id'], $product['product_id']),
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[$data['products'][] = array(]]></search>
			<add><![CDATA[
				$this->load->model('setting/setting');
				$data['tshirtecommerce_downloadable'] = (null !== $this->config->get('tshirtecommerce_downloadable')) ? $this->config->get('tshirtecommerce_downloadable') : 0;
				
				$_data = $this->model_tshirtecommerce_order->getItem($product['order_product_id'], $product['product_id']);
				$chk_return = false;
				// Check $design free or not
				$store_setting = array();
				$store_temp = array();
				$msg_store_empty = '';
				if (isset($dg) && $_data !== false && isset($_data->rowid)) {
					$cache = $dg->cache('cart');
					$design = $cache->get($_data->rowid);
					$order_item = $design['item'];
					$arts = array();
					$prices = 0;
					$qty = (int) ($order_item['qty'] / 10);
					if ($qty < 1) $qty = 1;

					if (isset($design['vector'])) {
						$ids = array();
						$vectors = json_decode($design['vector'], true);
						if (count($vectors)) {
							foreach ($vectors as $view => $items) {
								if (count($items)) {
									foreach ($items as $item) {
										if (isset($item['clipar_type']) && empty($item['clipar_paid'])) {
											if (empty($item['price'])) $item['price'] = 0;
											if (is_string($item['file'])) $file = $item['file'];
											if (isset($item['file']['type'])) $file = $item['file']['type'];
											$arts[$item['clipart_id']] = array(
												'view' => $view,
												'id' => $item['clipart_id'],
												'title'	=> $item['title'],
												'thumb'	=> $item['thumb'],
												'file' => $file,
												'price'	=> $item['price'],
											);
											if (!in_array($item['clipart_id'].'-'.$qty, $ids)) {
												$prices = $prices + ($item['price'] * $qty);
												$ids[] 	= $item['clipart_id'].'-'.$qty;
											}
										}
									}
									// update info after paid
									if (isset($this->request->get['e_order_id']) && isset($this->request->get['params']) 
										&& count($ids) > 0 && $data['design_id'] == $this->request->get['e_order_id']) {
										$e_order_id = $this->request->get['e_order_id'];
										$params = $this->request->get['params'];
										$settings = $dg->getSetting();
										$api = $settings->store->api;
										store_art_update($e_order_id, $params, array(), $api);
										$chk_return = true;
									}
								}
							}
						}
					}
					if (count($arts) && $chk_return == false) {
						$settings = $dg->getSetting();
						if (empty($settings->store)) {
							$msg_store_empty = '<p style="background-color: #fcf8e3;color:#8a6d3b;border: 1px solid #faebcc;padding:14px 12px;margin: 0px;">Your order using arts of <a href="http://store.9file.net/" target="_blank">store</a>. You missing setup API Store. Please go to <strong>T-Shirt eCommerce > Settings > Configuration > Tab Config</strong> setup store to download file output.</p>';
						} elseif (empty($settings->store->api) || (isset($settings->store->api) && $settings->store->api == '')) {
							$msg_store_empty = '<p style="background-color: #fcf8e3;color:#8a6d3b;border: 1px solid #faebcc;padding:14px 12px;margin: 0px;">Your order using arts of <a href="http://store.9file.net/" target="_blank">store</a>. You missing setup API Store. Please go to <strong>T-Shirt eCommerce > Settings > Configuration > Tab Config</strong> setup store to download file output.</p>';
						} else {
							$api = $settings->store->api;
							$store_temp['api'] = $api;
							$store_temp['ids'] = $ids;
							$store_temp['ids'] = $ids;
							$store_temp['prices'] = $prices;
							$store_temp['arts'] = $arts;
							$store_temp['qty'] = $qty;
						}
					}
				}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[$data['products'][] = array(]]></search>
			<add><![CDATA[
				'design' => $this->model_tshirtecommerce_order->getItem($product['order_product_id'], $product['product_id']),
				'_design' => isset($design) ? $design : array(),
				'store_temp' => $store_temp,
				'msg_store_empty' => $msg_store_empty,
				'u_return' => $chk_return,
			]]></add>
		</operation>
	</file>
	<file name="catalog/view/theme/*/template/account/order_info.tpl,system/storage/modification/catalog/view/theme/*/template/account/order_info.tpl">
		<operation error="skip">
			<search position="after"><![CDATA[echo $product['name']]]></search>
			<add><![CDATA[
				<?php if (isset($product['design']) && $product['design'] != false && isset($product['design']->rowid)) {
					$design = $product['design'];
					if (isset($design->design_product_id) && !empty($design->design_product_id)) {
						$_temp_arr = explode(':', $design->design_product_id);
						if (count($_temp_arr) > 1) {
							$_key = $_temp_arr[0].':'.$_temp_arr[1].':'.$_temp_arr[2].':'.$design->color_hex;
							echo '<p>';
							echo "<a href='".$base_url."index.php?route=tshirtecommerce/designer&product_id=".$_temp_arr[2]. '&parent_id='.$design->product_id ."&cart_id=".$design->rowid."' title='' target='_blank'><strong>".$tshirtecommerce_designer_cart_edit."</strong></a>";
							if (isset($tshirtecommerce_downloadable) && $tshirtecommerce_downloadable == 1 && (!isset($design->images) || empty($design->images))) {
								echo ' '.$tshirtecommerce_label_or_download_design.': ';
								echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='$base_url/tshirtecommerce/design.php?idea=1&key=".$_key."&view=front'><strong>".$tshirtecommerce_view_front."</strong></a> - ";
								echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='$base_url/tshirtecommerce/design.php?idea=1&key=".$_key."&view=back'><strong>".$tshirtecommerce_view_back."</strong></a> - ";
								echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='$base_url/tshirtecommerce/design.php?idea=1&key=".$_key."&view=left'><strong>".$tshirtecommerce_view_left."</strong></a> - ";
								echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='$base_url/tshirtecommerce/design.php?idea=1&key=".$_key."&view=right'><strong>".$tshirtecommerce_view_right."</strong></a>";
							}
							echo '</p>';
						} else {
							if (isset($design->images) && !empty($design->images)) {
								echo '<br /><p>';
								echo "<a href='".$base_url."index.php?route=tshirtecommerce/designer&product_id=".$design->design_product_id."&parent_id=".$design->product_id."&cart_id=".$design->rowid."' title='' target='_blank'><strong>".$tshirtecommerce_designer_cart_edit."</strong></a>";
								echo '</p>';
							}
						}
					}

					if (isset($design->color_title)) { ?>
						<br /><small><strong>Color:</strong><span title="<?php echo $design->color_title; ?>" style="background-color:#<?php echo $design->color_hex; ?>;display:inline-block;border:1px solid #ccc;width:25px;height:25px;cursor:pointer;outline:1px solid #229BCA;margin-left 4px;"></span></small><br />
					<?php }

					/* options */
					if (isset($design->options) && $design->options != '[]') {
						$design_options = is_string($design->options) ? json_decode(str_replace('&quot;', '"', $design->options)) : $design->options;
						if (is_object($design_options)) $design_options = (array) $design_options;
						$html = '';
						if (count($design_options)) {
							foreach ($design_options as $option) {
								if (isset($option->value)) {
									if (is_string($option->value) && $option->value != '') {
										// Fixed Printing type is empty
										if (empty($option->name) && $option->type == 'printing') {
											$option->name = $tshirtecommerce_printing_type; //'Printing type'
										}
										$html .= '<dt>'.$option->name.': '.$option->value.'</dt>';
									} elseif (isset($option->value) && count($option->value) > 0) {
										$html .= '<dt>'.$option->name.': </dt>';
										$html .=  '<dd>';
										foreach ((array)$option->value as $name => $value) {
											if ($option->type == 'checkbox') {
												$html .= $value. '; ';
											} else {
												if ($value != '0' && $value != 0) {
													$html .= $name.'  -  '.$value. '; ';
												}
											}
										}
										$html .=  '</dd>';
									}
								}
							}
						}
						echo $html;
					}
					/* teams */
					if (isset($design->teams) && isset($design->teams->name)) {
						$teams = json_decode( json_encode($design->teams), true );
						$table = '<table class="table table-bordered">'
							. 		'<thead>'
							. 			'<tr>'
							. 				'<th>'.$ts_designer_clipart_edit_name.'</th>'
							. 				'<th>'.$ts_designer_clipart_edit_number.'</th>'
							. 				'<th>'.$tshirtecommerce_head_text_sizes.'</th>'
							. 			'</tr>'
							. 		'</thead>'
							. 		'<tbody>';
						for ($i = 1; $i <= count($teams['name']); $i++) {
							$size = explode('::', $teams['size'][$i]);
							$table .=	'<tr>'
								.			'<td>'.$teams['name'][$i].'</td>'
								.			'<td>'.$teams['number'][$i].'</td>'
								.			'<td>'.$size[0].'</td>'
								.		'</tr>';
						}
						$table .= '</tbody></table>';
						echo $table;
					}
					/* images */
					if (isset($design->images)) {
						$images = json_decode(str_replace('&quot;', '"', $design->images), true);
						if (count($images) > 0) {								
							$img = '';
							foreach ($images as $view => $src) {
								$img .= '<div class="img-thumbnail" style="margin:2px;">'											
										.'<a target="_blank" href="'.$base_url.'/tshirtecommerce/'.$src.'" class="pull-left" title="Click to view design"><img style="width:80px;" src="'.$base_url.'/tshirtecommerce/'.$src.'" alt="" title="'.$tshirtecommerce_link_title_edit.'"></a>';
								
								if (isset($tshirtecommerce_downloadable) && $tshirtecommerce_downloadable == 1 && isset($product['store_temp']) && count($product['store_temp']) == 0) {
									$img .= '<br /><center><a target="_blank" href="'.$base_url.'/tshirtecommerce/design.php?key='.$design->rowid.'&view='.$view.'&session_id='.session_id().'" title="'.$tshirtecommerce_link_title_download.'" alt="'.$tshirtecommerce_link_text_download.'">'.$tshirtecommerce_link_text_download.'</a></center>';
								}
								$img .=	'</div>';
							}
							echo $img;
						}
					}
				} ?>
			]]></add>
		</operation>
	</file>
	<file name="catalog/view/theme/*/template/mail/order.tpl,system/storage/modification/catalog/view/theme/*/template/mail/order.tpl">
		<operation error="skip">
			<search position="after"><![CDATA[echo $option['value']]]></search>
			<add><![CDATA[
				<?php
				}
				echo '<br />';
				if (isset($product['design']) && $product['design'] != false) {
					$design = $product['design'];
					if (isset($design->design_product_id) && !empty($design->design_product_id)) {
						$_temp_arr = explode(':', $design->design_product_id);
						if (count($_temp_arr) > 1) {
							$_key = $_temp_arr[0].':'.$_temp_arr[1].':'.$_temp_arr[2].':'.$design->color_hex;
							echo '<p>';
							echo "<a href='".$base_url."index.php?route=tshirtecommerce/designer&product_id=".$_temp_arr[2]. '&parent_id='.$design->product_id ."&cart_id=".$design->rowid."' title='' target='_blank'><strong>".$tshirtecommerce_designer_cart_edit."</strong></a>";

							if (isset($tshirtecommerce_downloadable) && $tshirtecommerce_downloadable == 1 && (!isset($design->images) || empty($design->images))) {
								echo ' '.$tshirtecommerce_label_or_download_design.': ';

								echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='".$base_url."/tshirtecommerce/design.php?idea=1&key=".$_key."&view=front'><strong>".$tshirtecommerce_view_front."</strong></a><span> - </span>";

								echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='".$base_url."/tshirtecommerce/design.php?idea=1&key=".$_key."&view=back'><strong>".$tshirtecommerce_view_back."</strong></a><span> - </span>";

								echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='".$base_url."/tshirtecommerce/design.php?idea=1&key=".$_key."&view=left'><strong>".$tshirtecommerce_view_left."</strong></a><span> - </span>";

								echo "<a title='".$tshirtecommerce_link_title_download."' target='_blank' href='".$base_url."/tshirtecommerce/design.php?idea=1&key=".$_key."&view=right'><strong>".$tshirtecommerce_view_right."</strong></a>";
							}
							echo '</p>';
						} else {
							if (isset($design->images) && !empty($design->images)) {
								echo '<p>';
								echo "<a href='".$base_url."index.php?route=tshirtecommerce/designer&product_id=".$design->design_product_id."&parent_id=".$design->product_id."&cart_id=".$design->rowid."' title='' target='_blank'><strong>".$tshirtecommerce_designer_cart_edit."</strong></a>";
								echo '</p>';
							}
						}
					}
					if (isset($design->color_title)) { ?>
						<p style='height:25px;width:auto'><strong>Color:</strong></p>
						<p title='<?php echo $design->color_title; ?>' style='background-color:#<?php echo $design->color_hex ?>; height:25px; width:25px;border: 1px solid #cdcdcd;outline: 1px solid #229BCA;margin: 2px;'></p>
						<br />
					<?php }
					/* options */
					if (isset($design->options) && $design->options != '[]') {
						$design_options = is_string($design->options) ? json_decode(str_replace('&quot;', '"', $design->options)) : $design->options;
						$html = '';
						if (count($design_options)) {
							foreach ($design_options as $option) {
								if (isset($option->value)) {
									if (is_string($option->value) && $option->value != '') {
										// Fixed Printing type is empty
										if (empty($option->name) && $option->type == 'printing') {
											$option->name = $tshirtecommerce_printing_type; //'Printing type'
										}
										$html .= '<p><strong>'.$option->name.': '.$option->value.'</strong></p>';
									} elseif (isset($option->value) && count($option->value) > 0) {
										$html .= '<p><strong>'.$option->name.':</strong> </p>';
										foreach ((array)$option->value as $name => $value) {
											if($value != '0' && $value != 0) {
												$html .=  $name.'  -  '.$value. '; ';
											}
										}
									}
								}
							}
						}
						echo $html;
					}
					/* teams */
					if (isset($design->teams) && isset($design->teams->name)) {
						$teams = json_decode( json_encode($design->teams), true );
						$table = '<table class="table table-bordered">'
							. 		'<thead>'
							. 			'<tr>'
							. 				'<th>'.$ts_designer_clipart_edit_name.'</th>'
							. 				'<th>'.$ts_designer_clipart_edit_number.'</th>'
							. 				'<th>'.$tshirtecommerce_head_text_sizes.'</th>'
							. 			'</tr>'
							. 		'</thead>'
							. 		'<tbody>';
						for ($i = 1; $i <= count($teams['name']); $i++) {
							$size = explode('::', $teams['size'][$i]);
							$table .=	'<tr>'
								.			'<td>'.$teams['name'][$i].'</td>'
								.			'<td>'.$teams['number'][$i].'</td>'
								.			'<td>'.$size[0].'</td>'
								.		'</tr>';
						}
						$table .= '</tbody></table>';
						echo $table;
					}
					/* images */
					if (isset($design->images)) {
						$images = json_decode(str_replace('&quot;', '"', $design->images), true);
						if (count($images) > 0) {								
							$img = '';
							foreach ($images as $view => $src) {
								$img .= '<center style="float:left;background-color: #fff;margin:2px;border: 1px solid #ddd;border-radius: 4px;display: inline-block;line-height: 1.42857;transition: all 0.2s ease-in-out 0s;padding: 4px;">';
								$img .= '<a target="_blank" href="'.$base_url.'/tshirtecommerce/'.$src.'" title="">';
								$img .= '<img style="width:70px;height:auto" src="'.$base_url.'/tshirtecommerce/'.$src.'" alt="" width="70px" />';
								if (isset($tshirtecommerce_downloadable) && $tshirtecommerce_downloadable == 1 && isset($product['store_temp']) && count($product['store_temp']) == 0) {
									$img .= '<br /><a href="'.$base_url.'/tshirtecommerce/design.php?key='.$design->rowid.'&view='.$view.'&session_id='.session_id().'" target="_blank" title="'.$tshirtecommerce_link_title_download.'">'.$tshirtecommerce_link_text_download.'</a>';
								}
								$img .= '</a>';
								$img .= '</center>';
							}
							echo $img;
						}
					} ?>
			]]></add>
		</operation>
	</file>
</modification>